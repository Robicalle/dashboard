<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Solution â€” Mission Control</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
        
        .header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 24px 32px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; font-weight: 700; }
        .header h1 span { color: #667eea; }
        .header .last-update { font-size: 0.8rem; color: #94a3b8; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        
        /* Stats cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; }
        .stat-card .stat-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .stat-card .stat-value { font-size: 1.8rem; font-weight: 700; }
        .stat-card .stat-value.green { color: #4ade80; }
        .stat-card .stat-value.blue { color: #60a5fa; }
        .stat-card .stat-value.purple { color: #a78bfa; }
        .stat-card .stat-value.orange { color: #fb923c; }
        
        /* Monthly table */
        .section { background: #1e293b; border-radius: 12px; padding: 24px; border: 1px solid #334155; margin-bottom: 24px; }
        .section h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .section h2 i { color: #667eea; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 12px; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #334155; }
        td { padding: 10px 12px; font-size: 0.9rem; border-bottom: 1px solid #1e293b; }
        tr:hover { background: #334155; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 700; }
        .text-green { color: #4ade80; }
        .text-blue { color: #60a5fa; }
        .text-yellow { color: #fbbf24; }
        .text-purple { color: #a78bfa; }
        .text-dim { color: #64748b; }
        tr.total-row { background: #334155; font-weight: 700; }
        tr.total-row td { border-top: 2px solid #667eea; }
        
        /* Bar chart */
        .bar-container { display: flex; align-items: flex-end; gap: 8px; height: 180px; margin-top: 16px; padding: 0 8px; }
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .bar { width: 100%; border-radius: 4px 4px 0 0; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); min-height: 2px; transition: height 0.3s; position: relative; }
        .bar-label { font-size: 0.65rem; color: #94a3b8; }
        .bar-value { font-size: 0.65rem; color: #e2e8f0; font-weight: 600; }
        
        /* Lead prioritari */
        .lead-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #334155; }
        .lead-row:last-child { border-bottom: none; }
        .lead-name { font-weight: 600; }
        .lead-detail { font-size: 0.8rem; color: #94a3b8; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        .badge-red { background: #7f1d1d; color: #fca5a5; }
        .badge-yellow { background: #78350f; color: #fde68a; }
        .badge-green { background: #14532d; color: #86efac; }
        
        /* Automazioni */
        .auto-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; }
        .auto-card { background: #0f172a; border-radius: 8px; padding: 14px; display: flex; align-items: center; gap: 12px; }
        .auto-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .auto-icon.active { background: #14532d; color: #4ade80; }
        .auto-icon.paused { background: #78350f; color: #fbbf24; }
        .auto-name { font-size: 0.85rem; font-weight: 600; }
        .auto-schedule { font-size: 0.7rem; color: #94a3b8; }
        
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 768px) { .two-col { grid-template-columns: 1fr; } }
        
        /* AttivitÃ  recenti */
        .activity-item { padding: 8px 0; border-bottom: 1px solid #334155; font-size: 0.85rem; }
        .activity-item:last-child { border-bottom: none; }
        .activity-time { color: #94a3b8; font-size: 0.75rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-rocket"></i> Print Solution â€” <span>Mission Control</span></h1>
        <div class="last-update" id="lastUpdate"></div>
    </div>
    
    <div class="container">
        <!-- Stats -->
        <div class="stats-grid" id="statsGrid"></div>
        
        <!-- Grafico barre: Consuntivo vs Budget vs 2025 -->
        <div class="section">
            <h2><i class="fas fa-chart-bar"></i> Fatturato 2026 vs Budget vs 2025</h2>
            <div style="display:flex;gap:16px;margin-bottom:12px;font-size:0.75rem;">
                <div><span style="display:inline-block;width:12px;height:12px;background:linear-gradient(180deg,#4ade80,#22c55e);border-radius:2px;margin-right:4px;vertical-align:middle;"></span>Consuntivo 2026</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:linear-gradient(180deg,#60a5fa,#3b82f6);border-radius:2px;margin-right:4px;vertical-align:middle;"></span>Budget 2026</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:#475569;border-radius:2px;margin-right:4px;vertical-align:middle;"></span>2025</div>
            </div>
            <div class="bar-container" id="barChart" style="height:220px;"></div>
        </div>
        
        <!-- Tabella mensile con budget -->
        <div class="section">
            <h2><i class="fas fa-table"></i> Dettaglio Mensile</h2>
            <div style="overflow-x: auto;">
                <table id="monthlyTable">
                    <thead>
                        <tr>
                            <th>Mese</th>
                            <th class="text-right">G10 Macchine</th>
                            <th class="text-right">G40 Consum.</th>
                            <th class="text-right">G50 Ricambi</th>
                            <th class="text-right">G60 Etich.</th>
                            <th class="text-right">Consuntivo</th>
                            <th class="text-right">Budget</th>
                            <th class="text-right">Î”%</th>
                            <th class="text-right">Previsione</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyBody"></tbody>
                </table>
            </div>
        </div>
        
        <div class="two-col">
            <!-- Lead prioritari -->
            <div class="section">
                <h2><i class="fas fa-fire"></i> Lead Prioritari</h2>
                <div id="leadList"></div>
            </div>
            
            <!-- Automazioni -->
            <div class="section">
                <h2><i class="fas fa-cogs"></i> Automazioni Attive</h2>
                <div class="auto-grid" id="autoGrid"></div>
            </div>
        </div>
        
        <div class="two-col">
            <!-- Prossimi passi -->
            <div class="section">
                <h2><i class="fas fa-tasks"></i> Prossimi Passi</h2>
                <div id="nextSteps"></div>
            </div>
            
            <!-- AttivitÃ  recenti -->
            <div class="section">
                <h2><i class="fas fa-history"></i> AttivitÃ  Recenti</h2>
                <div id="recentActivity"></div>
            </div>
        </div>
    </div>

    <script>
    fetch('dashboard_data.json?v=' + Date.now())
        .then(r => r.json())
        .then(data => render(data))
        .catch(e => {
            document.querySelector('.container').innerHTML = '<div class="section"><h2>Errore caricamento dati</h2></div>';
        });

    function fmt(n) {
        if (n === undefined || n === null || isNaN(n)) return '\u20AC0';
        return '\u20AC' + Math.round(n).toLocaleString('it-IT');
    }

    function render(data) {
        document.getElementById('lastUpdate').textContent = 'Ultimo aggiornamento: ' + (data.lastUpdate || '-');

        const stats = data.stats || {};
        const mesi = data.mesi || [];
        const budgetAnnuale = data.budgetAnnuale || 2600000;
        const prevAnnuale = data.previsioneAnnuale || 0;
        const budgetYTD = mesi.filter(m => m.fatturato > 0).reduce((s,m) => s + (m.budget||0), 0);
        const deltaYTD = budgetYTD > 0 ? ((stats.fatturato - budgetYTD) / budgetYTD * 100).toFixed(1) : 0;
        const deltaColor = deltaYTD >= 0 ? '#4ade80' : '#f87171';
        const deltaSign = deltaYTD >= 0 ? '+' : '';
        const prevColor = prevAnnuale >= budgetAnnuale ? '#4ade80' : '#fb923c';

        document.getElementById('statsGrid').innerHTML =
            '<div class="stat-card"><div class="stat-label">Fatturato YTD 2026</div><div class="stat-value green">' + fmt(stats.fatturato) + '</div></div>' +
            '<div class="stat-card"><div class="stat-label">\u0394 vs Budget YTD</div><div class="stat-value" style="color:' + deltaColor + '">' + deltaSign + deltaYTD + '%</div><div style="font-size:0.75rem;color:#94a3b8;margin-top:4px;">Budget YTD: ' + fmt(budgetYTD) + '</div></div>' +
            '<div class="stat-card"><div class="stat-label">Proiezione Annuale</div><div class="stat-value" style="color:' + prevColor + '">' + fmt(prevAnnuale) + '</div><div style="font-size:0.75rem;color:#94a3b8;margin-top:4px;">su andamento + stagionalitÃ </div></div>' +
            '<div class="stat-card"><div class="stat-label">Obiettivo ' + (data.anno||2026) + '</div><div class="stat-value purple">' + fmt(budgetAnnuale) + '</div><div style="font-size:0.75rem;color:#94a3b8;margin-top:4px;">Residuo: ' + fmt(data.budgetResiduo||0) + '</div></div>';

        // Bar chart: 3 barre per mese (consuntivo, budget, 2025)
        var maxVal = Math.max(...mesi.map(m => Math.max(m.fatturato||0, m.budget||0, m.storico2025||0)), 1);
        var mesiLabels = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
        var chartHtml = '';
        mesi.forEach(function(m, i) {
            var hC = Math.max((m.fatturato||0) / maxVal * 200, 2);
            var hB = Math.max((m.budget||0) / maxVal * 200, 2);
            var h25 = Math.max((m.storico2025||0) / maxVal * 200, 2);
            chartHtml += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;">' +
                '<div style="display:flex;align-items:flex-end;gap:3px;height:200px;">' +
                '<div title="Consuntivo: ' + fmt(m.fatturato||0) + '" style="width:14px;height:' + hC + 'px;background:linear-gradient(180deg,#4ade80,#22c55e);border-radius:3px 3px 0 0;box-shadow:0 0 8px rgba(74,222,128,0.3);cursor:pointer;"></div>' +
                '<div title="Budget: ' + fmt(m.budget||0) + '" style="width:14px;height:' + hB + 'px;background:linear-gradient(180deg,#60a5fa,#3b82f6);border-radius:3px 3px 0 0;box-shadow:0 0 8px rgba(96,165,250,0.3);cursor:pointer;"></div>' +
                '<div title="2025: ' + fmt(m.storico2025||0) + '" style="width:14px;height:' + h25 + 'px;background:#475569;border-radius:3px 3px 0 0;cursor:pointer;"></div>' +
                '</div>' +
                '<div style="font-size:0.65rem;color:#94a3b8;">' + mesiLabels[i] + '</div></div>';
        });
        document.getElementById('barChart').innerHTML = chartHtml;

        // Monthly table with budget
        var totG10=0, totG40=0, totG50=0, totG60=0, totAll=0, totBudget=0, totPrev=0;
        var rows = '';
        mesi.forEach(function(m) {
            if (m.fatturato > 0 || (m.budget && m.budget > 0)) {
                totG10 += m.gruppo10||0; totG40 += m.gruppo40||0; totG50 += m.gruppo50||0; totG60 += m.gruppo60||0; totAll += m.fatturato||0; totBudget += m.budget||0; totPrev += m.previsione||m.fatturato||0;
                var delta = m.budget > 0 ? ((m.fatturato - m.budget) / m.budget * 100).toFixed(1) : '-';
                var dColor = delta >= 0 ? 'color:#4ade80' : 'color:#f87171';
                var dText = delta === '-' ? '-' : (delta >= 0 ? '+' : '') + delta + '%';
                var isFuturo = m.fatturato === 0 && m.budget > 0;
                var rowStyle = isFuturo ? ' style="opacity:0.6"' : '';
                var prevText = m.previsione > 0 ? fmt(m.previsione) : '-';
                var prevStyle = isFuturo ? 'color:#fb923c' : 'color:#94a3b8';
                rows += '<tr' + rowStyle + '>' +
                    '<td>' + m.mese + (isFuturo ? ' <span style="font-size:0.65rem;color:#64748b">ðŸ”®</span>' : '') + '</td>' +
                    '<td class="text-right text-blue">' + fmt(m.gruppo10) + '</td>' +
                    '<td class="text-right text-green">' + fmt(m.gruppo40) + '</td>' +
                    '<td class="text-right text-yellow">' + fmt(m.gruppo50) + '</td>' +
                    '<td class="text-right text-purple">' + fmt(m.gruppo60) + '</td>' +
                    '<td class="text-right font-bold">' + fmt(m.fatturato) + '</td>' +
                    '<td class="text-right text-dim">' + fmt(m.budget) + '</td>' +
                    '<td class="text-right" style="' + dColor + ';font-weight:700">' + dText + '</td>' +
                    '<td class="text-right" style="' + prevStyle + '">' + prevText + '</td></tr>';
            }
        });
        var dTot = totBudget > 0 ? ((totAll - totBudget) / totBudget * 100).toFixed(1) : '-';
        var dTotColor = dTot >= 0 ? 'color:#4ade80' : 'color:#f87171';
        var dTotText = dTot === '-' ? '-' : (dTot >= 0 ? '+' : '') + dTot + '%';
        rows += '<tr class="total-row"><td>TOTALE</td>' +
            '<td class="text-right text-blue">' + fmt(totG10) + '</td>' +
            '<td class="text-right text-green">' + fmt(totG40) + '</td>' +
            '<td class="text-right text-yellow">' + fmt(totG50) + '</td>' +
            '<td class="text-right text-purple">' + fmt(totG60) + '</td>' +
            '<td class="text-right">' + fmt(totAll) + '</td>' +
            '<td class="text-right text-dim">' + fmt(totBudget) + '</td>' +
            '<td class="text-right" style="' + dTotColor + ';font-weight:700">' + dTotText + '</td>' +
            '<td class="text-right" style="color:#fb923c">' + fmt(prevAnnuale) + '</td></tr>';
        document.getElementById('monthlyBody').innerHTML = rows;

        // Lead prioritari
        var leads = data.leadPrioritari || [];
        document.getElementById('leadList').innerHTML = leads.map(function(l) {
            var bc = l.priorita === 'high' ? 'badge-red' : l.priorita === 'medium' ? 'badge-yellow' : 'badge-green';
            var bt = l.priorita === 'high' ? 'CALDO' : l.priorita === 'medium' ? 'TIEPIDO' : 'FREDDO';
            return '<div class="lead-row"><div><div class="lead-name">' + l.azienda + '</div><div class="lead-detail">' + (l.contatto||'-') + ' \u2014 ' + (l.prodotto||'-') + '</div></div><span class="badge ' + bc + '">' + bt + '</span></div>';
        }).join('');

        // Automazioni
        var autos = data.automazioni || [];
        document.getElementById('autoGrid').innerHTML = autos.map(function(a) {
            var cls = a.status === 'active' ? 'active' : 'paused';
            return '<div class="auto-card"><div class="auto-icon ' + cls + '"><i class="fas fa-' + a.icon + '"></i></div><div><div class="auto-name">' + a.nome + '</div><div class="auto-schedule">' + a.schedule + '</div></div></div>';
        }).join('');

        // Prossimi passi
        var steps = data.prossimiPassi || [];
        document.getElementById('nextSteps').innerHTML = steps.map(function(s) {
            return '<div class="lead-row"><div><div class="lead-name"><i class="fas fa-' + s.icon + '" style="color:' + s.color + ';margin-right:8px;"></i>' + s.nome + '</div><div class="lead-detail">' + s.desc + '</div></div></div>';
        }).join('');

        // Attivita recenti
        var acts = data.attivitaRecenti || [];
        document.getElementById('recentActivity').innerHTML = acts.map(function(a) {
            return '<div class="activity-item"><div class="activity-time">' + a.tempo + '</div><div>' + a.azione + '</div></div>';
        }).join('');
    }
    </script>
</body>
</html>
